---
title: 【你不知道的JavaScript】1.作用域和闭包
tags:
  - 前端
  - JavaScript
keywords: JavaScript
description: 《你不知道的JavaScript》上卷。第一部分：作用域和闭包
excerpt: 《你不知道的JavaScript》上卷。第一部分：作用域和闭包
abbrlink: 1081e6d1
date: 2022-06-19 09:49:21
index_img: ../images/封面图/ydnkjs.png
---

# 1 作用域是什么

## 1.1 编译原理

编译的三个步骤：

1. 分词/词法分析（tokenizing/lexing）

   这个过程中，字符串将被分解成词法单元（token）。比如：`var a = 2` 将被分解为 `var`、`a`、`=`、`2`。

   > **分词**和**词法分析**的区别：词法单元生成器在判断 `a` 是一个独立的词法单元还是其它词法单元的一部分时，如果调用的是**有状态**的解析规则，那么这个过程就被称为**词法分析**。否则成为**分词**。

2. 解析/语法分析（parsing）

   这个过程是将 token 序列转换成一个由元素逐级嵌套所组成的抽象语法树（AST）。

3. 代码生成

   将 AST 转换成可执行代码的过程成为代码生成。

任何 JavaScript 代码片段在执行前都要进行编译，在此期间会对运行性能进行优化。

## 1.2 理解作用域

术语表：

1. 引擎

   负责整个 JavaScript 程序的编译及执行过程。

2. 编译器

   负责语法分析及代码生成。

3. 作用域

   负责收集并维护由所有变量组成的一系列查询，并实施一套非常严格的规则，确定当前执行的代码对这些标识符的访问权限。

变量的赋值操作会执行两个动作，首先编译器会在当前作用域中声明一个变量（如果当前变量没有声明过），然后，运行时引擎会在作用域中的查找该变量，如果能找到就会对它赋值。

引擎执行代码时，会通过查找变量来判断它是否已声明过。查找的过程由作用域协助，但是引擎执行怎样的查找，会影响最终的查找结果。

### LHS 和 RHS

查询类型分为两种，当变量出现在赋值操作的左侧时进行 LHS 查询，出现在右侧时进行 RHS 查询。更准确的讲，RHS 查询就是简单地查找某个变量的源值，而 LHS 查询则是试图找到变量的**容器**本身，从而对其进行赋值。从这个角度上讲，RHS 并不是真正意义上的“赋值操作的右侧”，更准确地说是“非左侧”。

例如：

对于代码 `console.log(a)`，其中对 a 的引用是一个 RHS 引用，因此这里 a 并没有被赋予任何值。相反，需要查找并取得 a 的值，这样才能将值传递给 `console.log()`。

对于代码 `a = 2`，这里对 a 的引用是 LHS 引用。因为，此时并不关心当前的值是什么，只想为 `= 2` 这个赋值操作找到一个目标。

> LHS 和 RHS 的含义是赋值操作的左侧或者右侧，但是并不意味着就是 `=` 的左侧或者右侧。因此在概念上，最好将其理解为“赋值操作的目标是谁（LHS）”以及“谁是赋值操作的源头（RHS）”。

## 1.3 作用域嵌套

作用域是根据名称查找变量的一套规则。当一个块或者函数嵌套在另一个块或者函数中时，也就是发生了作用域嵌套。遍历嵌套作用域链的规则：引擎从当前执行做哟关于开始查找变量，如果找不到，就向上一级继续查找。当抵达最外层作用域时查找过程停止。

## 1.4 异常

区分 LHS 和 RHS 是一件重要的事情。因为在变量还没有声明的情况下，这两种查询的行为是不一样的。

如果 RHS 查询在所有的嵌套作用域中都找不到所需的变量，引擎就会抛出 ReferenceError 异常。相较之下，如果 LHS 查询在所有嵌套作用域中找到目标变量时，全局作用域中就会创建一个具有该名称的变量，并将其返还给引擎（非严格模式）。

如果 RHS 查询找到了一个变量，但是对该变量的值进行不合理的操作，那么就会抛出 TypeError。

ReferenceError 同作用域判别失败，而 TypeError 则代表作用域判别成功了，但是对结果的操作不合理。

 

